<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‡∏£‡∏∞‡∏ö‡∏ö‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏° - The Points Collector</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Itim&family=Kanit:wght@300;400;500;600&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Kanit', sans-serif;
            background-color: #ffffff; /* White */
            color: #475569; /* Slate-600 */
            background-image: url("data:image/svg+xml,%3Csvg width='40' height='40' viewBox='0 0 40 40' xmlns='http://www.w3.org/2000/svg'%3E%3Cg fill='%23fef9c3' fill-opacity='0.8'%3E%3Ccircle cx='10' cy='10' r='4'/%3E%3Ccircle cx='30' cy='30' r='4'/%3E%3C/g%3E%3C/svg%3E");
            animation: moveBackground 5s linear infinite;
        }
        .main-title {
            font-family: 'Itim', cursive;
            color: #3b82f6; /* blue-500 */
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .content-card {
            background-color: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            border: 1px solid #e2e8f0; /* Slate-200 */
            box-shadow: 0 10px 15px -3px rgb(0 0 0 / 0.07), 0 4px 6px -4px rgb(0 0 0 / 0.07);
        }
        .btn-primary {
            background-image: linear-gradient(to right, #8b5cf6, #ec4899);
            color: white;
            transition: all 0.3s ease;
            border: none;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.4);
        }
        .modal {
            display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5); animation-name: fadeIn; animation-duration: 0.4s
        }
        .modal-content {
            margin: 10% auto; background-color: #f8fafc; color: #1e293b; border: 1px solid #e2e8f0;
            position: relative; padding: 20px; outline: 0; border-radius: 12px; width: 90%; max-width: 600px;
            box-shadow: 0 4px 8px 0 rgba(0,0,0,0.2),0 6px 20px 0 rgba(0,0,0,0.19); animation-name: slideIn; animation-duration: 0.4s
        }
        @keyframes slideIn { from {transform: translateY(50px); opacity: 0} to {transform: translateY(0); opacity: 1} }
        @keyframes fadeIn { from {opacity: 0} to {opacity: 1} }
        
        input, select {
            background-color: #f1f5f9 !important; /* Slate-100 */
            color: #1e293b !important; /* Slate-800 */
            border-color: #cbd5e1 !important; /* Slate-300 */
        }
        .swal2-popup {
            background: #ffffff !important;
            color: #334155 !important;
            border: 1px solid #e2e8f0 !important;
        }
        .swal2-title { color: #1e293b !important; font-family: 'Itim', cursive !important; }
        .swal2-html-container { color: #334155 !important; }
        .swal2-input, .swal2-select {
            width: 100% !important;
            margin: 0.5rem 0 0 0 !important;
        }


        .rank-1 { background-image: linear-gradient(to right, #fef9c3, #fde047); } /* yellow */
        .rank-2 { background-image: linear-gradient(to right, #f1f5f9, #e2e8f0); } /* slate */
        .rank-3 { background-image: linear-gradient(to right, #ffedd5, #fb923c); } /* orange */
        .filter-btn-active {
            background-image: linear-gradient(to right, #60a5fa, #3b82f6) !important;
            color: white !important;
            border-color: #2563eb !important; transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(59, 130, 246, 0.3);
        }
        /* Custom scrollbar */
        #class-tabs::-webkit-scrollbar { height: 6px; }
        #class-tabs::-webkit-scrollbar-track { background: #e2e8f0; border-radius: 10px; }
        #class-tabs::-webkit-scrollbar-thumb { background: #94a3b8; border-radius: 10px; }
        #class-tabs::-webkit-scrollbar-thumb:hover { background: #64748b; }

        @keyframes moveBackground {
            from {
                background-position: 0 0;
            }
            to {
                background-position: 40px 40px;
            }
        }

        #table-header {
            background-image: linear-gradient(to right, #cffafe, #a5f3fc);
        }
        #table-header th {
            color: #0e7490;
        }
        
        @keyframes flaming-gold {
            0% { box-shadow: 0 0 8px 4px rgba(255, 223, 0, 0.8), 0 0 20px 10px rgba(255, 165, 0, 0.7), 0 0 35px 18px rgba(255, 69, 0, 0.6); }
            50% { box-shadow: 0 0 12px 6px rgba(255, 223, 0, 1), 0 0 30px 15px rgba(255, 165, 0, 0.9), 0 0 50px 25px rgba(255, 69, 0, 0.8); }
            100% { box-shadow: 0 0 8px 4px rgba(255, 223, 0, 0.8), 0 0 20px 10px rgba(255, 165, 0, 0.7), 0 0 35px 18px rgba(255, 69, 0, 0.6); }
        }

        @keyframes flaming-silver {
            0% { box-shadow: 0 0 8px 4px rgba(255, 255, 255, 0.8), 0 0 20px 10px rgba(173, 216, 230, 0.7), 0 0 35px 18px rgba(0, 191, 255, 0.6); }
            50% { box-shadow: 0 0 12px 6px rgba(255, 255, 255, 1), 0 0 30px 15px rgba(173, 216, 230, 0.9), 0 0 50px 25px rgba(0, 191, 255, 0.8); }
            100% { box-shadow: 0 0 8px 4px rgba(255, 255, 255, 0.8), 0 0 20px 10px rgba(173, 216, 230, 0.7), 0 0 35px 18px rgba(0, 191, 255, 0.6); }
        }

        @keyframes flaming-bronze {
            0% { box-shadow: 0 0 6px 3px rgba(255, 165, 0, 0.7), 0 0 15px 8px rgba(255, 69, 0, 0.6), 0 0 25px 15px rgba(220, 20, 60, 0.5); }
            50% { box-shadow: 0 0 10px 5px rgba(255, 165, 0, 0.9), 0 0 25px 12px rgba(255, 69, 0, 0.8), 0 0 40px 20px rgba(220, 20, 60, 0.7); }
            100% { box-shadow: 0 0 6px 3px rgba(255, 165, 0, 0.7), 0 0 15px 8px rgba(255, 69, 0, 0.6), 0 0 25px 15px rgba(220, 20, 60, 0.5); }
        }

        .flaming-gold { animation: flaming-gold 1.5s ease-in-out infinite; border-radius: 0.5rem; position: relative; z-index: 1; }
        .flaming-silver { animation: flaming-silver 1.8s ease-in-out infinite; border-radius: 0.5rem; position: relative; z-index: 1; }
        .flaming-bronze { animation: flaming-bronze 2s ease-in-out infinite; border-radius: 0.5rem; position: relative; z-index: 1; }

    </style>
</head>
<body class="text-slate-700">

    <!-- Main Container -->
    <div id="app" class="mx-auto px-2 md:px-6 py-4">
        
        <!-- Login View -->
        <div id="login-view" class="hidden">
            <div class="content-card p-8 rounded-2xl shadow-lg text-center">
                <h1 class="text-3xl font-bold text-slate-800 mb-2" style="font-family: 'Itim', cursive;">üßë‚Äçüè´ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π</h1>
                <p class="text-slate-500 mb-6">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                <input type="password" id="password" class="w-full max-w-xs p-3 border rounded-lg mb-4 text-center">
                <button id="login-btn" class="w-full max-w-xs btn-primary font-semibold py-3 px-4 rounded-lg shadow-md">‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö</button>
                <button id="back-to-scoreboard-btn" class="w-full max-w-xs bg-slate-500 hover:bg-slate-600 text-white font-semibold py-3 px-4 rounded-lg shadow-md mt-2 transition-all duration-300 hover:transform hover:-translate-y-0.5">‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡∏´‡∏ô‡πâ‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</button>
            </div>
        </div>

        <!-- Dashboard / Student View -->
        <div id="dashboard-view">
            <header class="flex flex-col md:flex-row justify-between items-center mb-6">
                <h1 class="text-5xl font-bold main-title">üéÆBoard Of Destiny ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡πÅ‡∏´‡πà‡∏á‡πÇ‡∏ä‡∏Ñ‡∏ä‡∏∞‡∏ï‡∏≤</h1>
                <div class="mt-4 md:mt-0 flex items-center space-x-2">
                     <button id="refresh-btn" class="bg-white hover:bg-gray-100 text-slate-600 font-semibold py-2 px-4 rounded-lg shadow-sm border border-slate-200 transition-all duration-300 hover:transform hover:-translate-y-0.5 flex items-center gap-2">üîÑ<span>‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</span></button>
                     <button id="rules-btn" class="bg-white hover:bg-gray-100 text-slate-600 font-semibold py-2 px-4 rounded-lg shadow-sm border border-slate-200 transition-all duration-300 hover:transform hover:-translate-y-0.5">üìú ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤</button>
                    <!-- Login Button for Guests/Students -->
                    <button id="show-login-btn" class="bg-gradient-to-r from-pink-500 to-purple-500 hover:from-pink-600 hover:to-purple-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:transform hover:-translate-y-0.5">üßë‚Äçüè´ ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</button>
                    <!-- Teacher Controls Dropdown -->
                    <div id="teacher-controls" class="hidden relative inline-block text-left">
                        <div>
                            <button type="button" id="teacher-menu-btn" class="inline-flex justify-center w-full rounded-lg border border-slate-300 shadow-sm px-4 py-2 bg-white text-sm font-medium text-slate-700 hover:bg-slate-50 focus:outline-none transition-all duration-300">
                                ‡πÄ‡∏°‡∏ô‡∏π‡∏Ñ‡∏£‡∏π üßë‚Äçüè´
                                <svg class="-mr-1 ml-2 h-5 w-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                            </button>
                        </div>
                        <div id="teacher-menu-dropdown" class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-10">
                            <div class="py-1">
                                <a href="#" id="fetch-gs-btn" class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center">üîÑ<span class="ml-2">‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></a>
                                <a href="#" id="admin-panel-btn" class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center">‚öôÔ∏è<span class="ml-2">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</span></a>
                                <a href="#" id="logout-btn" class="text-slate-700 block px-4 py-2 text-sm hover:bg-slate-100 flex items-center">üö™<span class="ml-2">‡∏≠‡∏≠‡∏Å‡∏à‡∏≤‡∏Å‡∏£‡∏∞‡∏ö‡∏ö</span></a>
                            </div>
                        </div>
                    </div>
                </div>
            </header>

            <!-- Mission Board -->
            <div id="mission-board" class="hidden content-card p-4 rounded-xl mb-6 bg-gradient-to-r from-violet-500 to-fuchsia-500 text-white shadow-lg">
                <h3 class="font-bold text-lg mb-2 flex items-center gap-2"><span class="text-2xl">üéØ</span> ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô</h3>
                <img id="mission-image" src="" class="hidden w-full h-48 object-contain rounded-md mb-2">
                <p id="mission-text" class="text-sm"></p>
            </div>
            
            <!-- Tabs for Classes -->
            <div id="class-tabs" class="flex items-center gap-3 mb-6 pb-3 overflow-x-auto">
                <!-- Tabs will be generated here -->
            </div>

            <!-- Leaderboard View Toggle -->
            <div id="leaderboard-filters" class="hidden mb-4 text-center">
                <div class="inline-flex rounded-lg shadow-md">
                    <button id="filter-individual-btn" class="px-5 py-2 text-sm font-semibold bg-white border border-slate-300 text-slate-600 rounded-l-lg transition-all duration-300 hover:bg-slate-100 hover:-translate-y-0.5 flex items-center gap-2">
                        üßë‚Äçüéì ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                    <button id="filter-class-btn" class="px-5 py-2 text-sm font-semibold bg-white border-t border-b border-r border-slate-300 text-slate-600 rounded-r-lg transition-all duration-300 hover:bg-slate-100 hover:-translate-y-0.5 flex items-center gap-2">
                        üè´ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô
                    </button>
                </div>
            </div>
            
            <!-- Class Sort Toggle -->
            <div id="class-sort-filters" class="hidden mb-4 text-center">
                <div class="inline-flex rounded-lg shadow-md">
                    <button id="sort-by-no-btn" class="px-5 py-2 text-sm font-semibold bg-white border border-slate-300 text-slate-600 rounded-l-lg transition-all duration-300 hover:bg-slate-100 hover:-translate-y-0.5 flex items-center gap-2">
                        <!-- Content generated by JS -->
                    </button>
                    <button id="sort-by-points-btn" class="px-5 py-2 text-sm font-semibold bg-white border-t border-b border-r border-slate-300 text-slate-600 rounded-r-lg transition-all duration-300 hover:bg-slate-100 hover:-translate-y-0.5 flex items-center gap-2">
                        <!-- Content generated by JS -->
                    </button>
                </div>
            </div>

            <!-- Student Table -->
            <div class="content-card p-6 rounded-2xl shadow-lg">
                <div class="overflow-x-auto">
                    <table class="w-full text-left">
                        <thead id="table-header">
                            <!-- Header will be generated here -->
                        </thead>
                        <tbody id="student-list">
                            <!-- Student rows will be generated here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Admin Panel View -->
        <div id="admin-view" class="hidden content-card p-6 rounded-2xl shadow-lg">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-slate-800" style="font-family: 'Itim', cursive;">üõ†Ô∏è ‡∏´‡∏ô‡πâ‡∏≤‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏£‡∏π</h2>
                <button id="back-to-dashboard-btn" class="bg-slate-500 hover:bg-slate-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all hover:transform hover:-translate-y-0.5"> &lt; ‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ Dashboard</button>
            </div>

            <!-- Mission Management -->
            <div class="admin-section">
                <h3 class="font-semibold text-xl mb-3 text-slate-800">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à üéØ</h3>
                <textarea id="new-mission-text" class="w-full p-2 border rounded-lg" rows="3" placeholder="‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà..."></textarea>
                <input type="text" id="new-mission-image-url" class="w-full p-2 border rounded-lg mt-2" placeholder="URL ‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)">
                <button id="announce-mission-btn" class="mt-2 w-full btn-primary font-semibold py-2 px-4 rounded-lg">‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à</button>
            </div>
            
            <!-- Point Management -->
            <div class="admin-section">
                <h3 class="font-semibold text-xl mb-4 text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡πÅ‡∏ï‡πâ‡∏° ‚ûï‚ûñ</h3>
                <div class="mb-4 text-center">
                    <div class="inline-flex rounded-lg shadow-md">
                        <button id="mode-single-btn" class="px-5 py-2 text-sm font-semibold bg-white border border-slate-300 text-slate-600 rounded-l-lg transition-all duration-300 hover:bg-slate-100 hover:-translate-y-0.5 flex items-center gap-2">
                            üë§ ‡∏£‡∏≤‡∏¢‡∏Ñ‡∏ô
                        </button>
                        <button id="mode-bulk-btn" class="px-5 py-2 text-sm font-semibold bg-white border-t border-b border-r border-slate-300 text-slate-600 rounded-r-lg transition-all duration-300 hover:bg-slate-100 hover:-translate-y-0.5 flex items-center gap-2">
                            üë• ‡πÅ‡∏ö‡∏ö‡∏Å‡∏•‡∏∏‡πà‡∏°
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-2">
                     <select id="class-select-for-points" class="p-2 border rounded-lg w-full">
                        <option value="">-- 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>
                    </select>
                    <!-- Search is for single mode only -->
                    <input type="text" id="search-student-admin" class="p-2 border rounded-lg w-full" placeholder="üîç ‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Å‡∏£‡∏≠‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠...">
                </div>
                
                <!-- Single Student Selector -->
                <div id="single-student-selector" class="mb-4">
                    <select id="student-select-for-points" class="p-2 border rounded-lg w-full">
                        <option value="">-- 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>
                    </select>
                </div>

                <!-- Bulk Student Selector -->
                <div id="bulk-student-selector" class="hidden mb-4 p-2 border rounded-lg bg-slate-50 max-h-48 overflow-y-auto">
                    <div class="mb-2">
                        <input type="checkbox" id="select-all-students-checkbox" class="mr-2">
                        <label for="select-all-students-checkbox" class="font-semibold">‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î / ‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</label>
                    </div>
                    <div id="bulk-student-list" class="space-y-1">
                        <!-- Checkboxes will be generated here -->
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <input type="number" id="points-input" class="p-2 border rounded-lg" placeholder="‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏° (‡πÉ‡∏™‡πà‡πÄ‡∏•‡∏Ç‡∏ö‡∏ß‡∏Å‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)" min="0">
                    <input type="text" id="reason-input" class="p-2 border rounded-lg" placeholder="‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏• (‡πÄ‡∏ä‡πà‡∏ô ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô)">
                </div>
                <div class="mt-4 text-center space-x-2">
                    <button id="add-points-btn" class="bg-green-500 hover:bg-green-600 text-white font-bold py-2 px-6 rounded-lg transition-all hover:transform hover:-translate-y-0.5">‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÅ‡∏ï‡πâ‡∏°</button>
                    <button id="remove-points-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-2 px-6 rounded-lg transition-all hover:transform hover:-translate-y-0.5">‡∏•‡∏î‡πÅ‡∏ï‡πâ‡∏°</button>
                </div>
            </div>

            <!-- Class & Student Management -->
            <div class="admin-section">
                <h3 class="font-semibold text-xl mb-3 text-slate-800">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÅ‡∏•‡∏∞‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô üè´</h3>
                <div class="mb-4">
                    <h4 class="font-semibold mb-2 text-slate-800">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏´‡∏°‡πà</h4>
                    <div class="flex gap-2">
                        <input type="text" id="new-class-name" class="p-2 border rounded-lg w-full" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô (‡πÄ‡∏ä‡πà‡∏ô ‡∏°.1/5)">
                        <button id="add-class-btn" class="btn-primary font-semibold py-2 px-4 rounded-lg whitespace-nowrap">‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</button>
                    </div>
                </div>
                <div id="class-management-buttons" class="grid grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
                    <!-- Class buttons will be generated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Student Profile Modal -->
    <div id="profile-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b border-slate-300">
                <h3 id="modal-student-name" class="text-xl font-bold">‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <span class="close-btn text-3xl font-bold cursor-pointer transition-transform hover:rotate-90">&times;</span>
            </div>
            
            <div class="py-4">
                <div class="mb-4 text-center">
                    <div class="inline-flex rounded-lg shadow-sm">
                        <button id="profile-history-btn" class="px-5 py-2 text-sm font-semibold bg-white border border-slate-300 text-slate-600 rounded-l-lg transition-all duration-300">
                            üìú ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥
                        </button>
                        <button id="profile-graph-btn" class="px-5 py-2 text-sm font-semibold bg-white border-t border-b border-r border-slate-300 text-slate-600 rounded-r-lg transition-all duration-300">
                            üìà ‡∏Å‡∏£‡∏≤‡∏ü
                        </button>
                    </div>
                </div>

                <div id="profile-graph-view" class="hidden">
                    <h4 class="font-semibold text-lg mb-2">‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
                    <canvas id="profile-chart-canvas"></canvas>
                </div>
                <div id="profile-history-view" class="max-h-[60vh] overflow-y-auto">
                    <h4 class="font-semibold text-lg mb-2">‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h4>
                    <div id="modal-body">
                        <!-- History items will be here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Class Management Modal -->
    <div id="class-management-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b border-slate-300">
                <h3 id="class-modal-title" class="text-xl font-bold">‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</h3>
                <span class="close-btn text-3xl font-bold cursor-pointer transition-transform hover:rotate-90">&times;</span>
            </div>
            <div class="py-4 max-h-96 overflow-y-auto">
                <ul id="class-modal-student-list" class="space-y-2 mb-4">
                    <!-- Student list will be here -->
                </ul>
                <button id="class-modal-add-student-btn" class="w-full bg-green-500 hover:bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md transition-all duration-300 hover:transform hover:-translate-y-0.5">+ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</button>
            </div>
        </div>
    </div>

    <!-- Rules Modal -->
    <div id="rules-modal" class="modal">
        <div class="modal-content">
            <div class="flex justify-between items-center pb-3 border-b border-slate-300">
                <h3 class="text-xl font-bold" style="font-family: 'Itim', cursive;">üìú ‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô</h3>
                <span class="close-btn text-3xl font-bold cursor-pointer transition-transform hover:rotate-90">&times;</span>
            </div>
            <div id="rules-body" class="py-4 space-y-3">
                <p class="font-semibold">‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤:</p>
                <ul class="list-disc list-inside space-y-2">
                    <li><span class="font-semibold text-green-500">‚úÖ +10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span> ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ï‡∏£‡∏á‡πÄ‡∏ß‡∏•‡∏≤</li>
                    <li><span class="font-semibold text-green-500">‚úÖ +5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span> ‡∏°‡∏µ‡∏™‡πà‡∏ß‡∏ô‡∏£‡πà‡∏ß‡∏°‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>
                    <li><span class="font-semibold text-green-500">‚úÖ +20 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span> ‡∏ä‡πà‡∏ß‡∏¢‡πÄ‡∏´‡∏•‡∏∑‡∏≠‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏ô, ‡∏ó‡∏≥‡∏Ñ‡∏ß‡∏≤‡∏°‡∏î‡∏µ</li>
                    <li><span class="font-semibold text-red-500">‚ùå -10 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span> ‡∏™‡πà‡∏á‡∏á‡∏≤‡∏ô‡∏ä‡πâ‡∏≤</li>
                    <li><span class="font-semibold text-red-500">‚ùå -5 ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô:</span> ‡πÑ‡∏°‡πà‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</li>
                </ul>
                <p class="text-sm text-slate-500 mt-4">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏£‡∏π‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏Å‡∏ï‡∏¥‡∏Å‡∏≤‡πÄ‡∏´‡∏•‡πà‡∏≤‡∏ô‡∏µ‡πâ‡πÑ‡∏î‡πâ‡∏ï‡∏≤‡∏°‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏™‡∏°</p>
            </div>
        </div>
    </div>


    <script>
        let APP_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzPCtXfigpfdXVVAKkKhX_jzgSfU922lSftrIr80gSte8ZRufK72PMjARudsJ1wSMZ3/exec';
        const LEADERBOARD_KEY = 'üèÜ Leaderboard ‡∏£‡∏ß‡∏°';
        const CLASS_LEADERBOARD_KEY = 'üè´ ‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô';
        
        // --- DOM Elements ---
        const loginView = document.getElementById('login-view');
        const dashboardView = document.getElementById('dashboard-view');
        const adminView = document.getElementById('admin-view');
        const studentList = document.getElementById('student-list');
        const tableHeader = document.getElementById('table-header');
        const classTabs = document.getElementById('class-tabs');
        const profileModal = document.getElementById('profile-modal');
        const rulesModal = document.getElementById('rules-modal');
        const classManagementModal = document.getElementById('class-management-modal');
        const modalStudentName = document.getElementById('modal-student-name');
        const modalBody = document.getElementById('modal-body');
        const teacherMenuBtn = document.getElementById('teacher-menu-btn');
        const teacherMenuDropdown = document.getElementById('teacher-menu-dropdown');
        const leaderboardFilters = document.getElementById('leaderboard-filters');
        const filterIndividualBtn = document.getElementById('filter-individual-btn');
        const filterClassBtn = document.getElementById('filter-class-btn');
        const classSortFilters = document.getElementById('class-sort-filters');
        const sortByNoBtn = document.getElementById('sort-by-no-btn');
        const sortByPointsBtn = document.getElementById('sort-by-points-btn');
        const modeSingleBtn = document.getElementById('mode-single-btn');
        const modeBulkBtn = document.getElementById('mode-bulk-btn');
        const singleStudentSelector = document.getElementById('single-student-selector');
        const bulkStudentSelector = document.getElementById('bulk-student-selector');
        const bulkStudentList = document.getElementById('bulk-student-list');
        const selectAllCheckbox = document.getElementById('select-all-students-checkbox');
        const classManagementButtons = document.getElementById('class-management-buttons');
        const classModalTitle = document.getElementById('class-modal-title');
        const classModalStudentList = document.getElementById('class-modal-student-list');
        const classModalAddStudentBtn = document.getElementById('class-modal-add-student-btn');
        const avatars = ['üêµ','üê∂','ü¶ä','üê±','ü¶Å','üêØ','üê¥','ü¶Ñ','ü¶ì','üêÆ','üê∑','üê≠','üêπ','üê∞','üêª','üê®','üêº','üê∏','üêß'];
        const badgeColors = [
            'bg-pink-200 text-pink-800',
            'bg-purple-200 text-purple-800',
            'bg-indigo-200 text-indigo-800',
            'bg-cyan-200 text-cyan-800',
            'bg-teal-200 text-teal-800',
        ];
        const profileGraphBtn = document.getElementById('profile-graph-btn');
        const profileHistoryBtn = document.getElementById('profile-history-btn');
        const profileGraphView = document.getElementById('profile-graph-view');
        const profileHistoryView = document.getElementById('profile-history-view');
        
        let profileChart = null;
        
        // --- State ---
        let state = {
            students: {}, // { id, no, prefix, firstName, lastName, class, points, history: [] }
            classes: [],  // ["‡∏°.1/1", "‡∏°.1/3"]
            activeClass: null,
            leaderboardView: 'individual', // 'individual' or 'class'
            classSort: { key: 'no', order: 'asc' }, // { key: 'no' | 'points', order: 'asc' | 'desc' }
            loggedIn: false,
            adminPointMode: 'single', // 'single' or 'bulk'
            mission: { text: '', timestamp: null, imageUrl: '' }
        };

        // --- App Logic ---
        function initializeApp() {
            state.activeClass = LEADERBOARD_KEY; 
            showDashboard();
            fetchFromGoogleSheet();
            document.getElementById('refresh-btn').addEventListener('click', fetchFromGoogleSheet);
            document.getElementById('announce-mission-btn').addEventListener('click', announceMission);
        }
        
        // Natural Sort for class names like "‡∏°.1/1", "‡∏°.1/11"
        function naturalSort(a, b) {
            const collator = new Intl.Collator(undefined, { numeric: true, sensitivity: 'base' });
            return collator.compare(a, b);
        }

        function render() {
            renderTabs();
            renderDynamicControls();
            renderStudentList();
            updateUIVisibility();
            renderMissionBoard();
        }

        function updateUIVisibility() {
            const teacherControls = document.getElementById('teacher-controls');
            const showLoginBtn = document.getElementById('show-login-btn');
            if (state.loggedIn) {
                teacherControls.classList.remove('hidden');
                showLoginBtn.classList.add('hidden');
            } else {
                teacherControls.classList.add('hidden');
                teacherMenuDropdown.classList.add('hidden');
                showLoginBtn.classList.remove('hidden');
            }
        }
        
        function renderMissionBoard() {
            if (state.mission && state.mission.text) {
                document.getElementById('mission-text').textContent = state.mission.text;
                const missionImage = document.getElementById('mission-image');
                if(state.mission.imageUrl) {
                    missionImage.src = state.mission.imageUrl;
                    missionImage.classList.remove('hidden');
                } else {
                    missionImage.classList.add('hidden');
                }
                document.getElementById('mission-board').classList.remove('hidden');
            } else {
                document.getElementById('mission-board').classList.add('hidden');
            }
        }
        
        function checkAndShowNewMission() {
            const lastSeenTimestamp = localStorage.getItem('seenMissionTimestamp');
            if (state.mission && state.mission.timestamp && state.mission.timestamp > lastSeenTimestamp) {
                Swal.fire({
                    title: 'üéØ ‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÉ‡∏´‡∏°‡πà!',
                    text: state.mission.text,
                    imageUrl: state.mission.imageUrl || undefined,
                    imageWidth: 400,
                    imageAlt: 'Mission Image',
                    confirmButtonText: '‡∏£‡∏±‡∏ö‡∏ó‡∏£‡∏≤‡∏ö!'
                }).then(() => {
                    localStorage.setItem('seenMissionTimestamp', state.mission.timestamp);
                });
            }
        }

        function renderTabs() {
            classTabs.innerHTML = '';
            const baseTabClass = 'flex-shrink-0 px-4 py-2 font-semibold transition-all duration-300 rounded-lg shadow-md border';
            
            // Render leaderboard tab
            const leaderboardTab = document.createElement('button');
            leaderboardTab.innerHTML = LEADERBOARD_KEY;
            const activeLeaderboardClass = 'bg-gradient-to-r from-amber-400 to-yellow-400 text-white border-amber-500 transform -translate-y-1 shadow-lg';
            const inactiveLeaderboardClass = 'bg-white text-amber-700 border-slate-200 hover:bg-amber-50 hover:-translate-y-0.5';
            leaderboardTab.className = `${baseTabClass} ${state.activeClass === LEADERBOARD_KEY ? activeLeaderboardClass : inactiveLeaderboardClass}`;
            leaderboardTab.onclick = () => {
                state.activeClass = LEADERBOARD_KEY;
                render();
            };
            classTabs.appendChild(leaderboardTab);

            // Render class tabs
            state.classes.forEach(className => {
                const tab = document.createElement('button');
                tab.textContent = className;
                const activeClass = 'bg-gradient-to-r from-sky-500 to-blue-500 text-white border-blue-600 transform -translate-y-1 shadow-lg';
                const inactiveClass = 'bg-white text-slate-700 border-slate-200 hover:bg-slate-100 hover:-translate-y-0.5';
                tab.className = `${baseTabClass} ${state.activeClass === className ? activeClass : inactiveClass}`;
                tab.onclick = () => { 
                    state.activeClass = className;
                    render();
                };
                classTabs.appendChild(tab);
            });
        }
        
        function renderDynamicControls() {
            const isLeaderboard = state.activeClass === LEADERBOARD_KEY;
            
            leaderboardFilters.classList.toggle('hidden', !isLeaderboard);
            classSortFilters.classList.toggle('hidden', isLeaderboard);

            if (isLeaderboard) {
                filterIndividualBtn.classList.toggle('filter-btn-active', state.leaderboardView === 'individual');
                filterClassBtn.classList.toggle('filter-btn-active', state.leaderboardView === 'class');
            } else {
                sortByNoBtn.classList.toggle('filter-btn-active', state.classSort.key === 'no');
                sortByPointsBtn.classList.toggle('filter-btn-active', state.classSort.key === 'points');
                
                const noBtnText = "üî¢ ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà";
                const pointsBtnText = "‚ú® ‡πÄ‡∏£‡∏µ‡∏¢‡∏á‡∏ï‡∏≤‡∏°‡πÅ‡∏ï‡πâ‡∏°";
                
                sortByNoBtn.innerHTML = noBtnText;
                sortByPointsBtn.innerHTML = pointsBtnText;

                const sortIcon = state.classSort.order === 'asc' ? 'üîº' : 'üîΩ';

                if (state.classSort.key === 'no') {
                    sortByNoBtn.innerHTML = `${noBtnText} ${sortIcon}`;
                } else {
                    sortByPointsBtn.innerHTML = `${pointsBtnText} ${sortIcon}`;
                }
            }
        }

        function handleSort(key) {
            if (state.classSort.key === key) {
                state.classSort.order = state.classSort.order === 'asc' ? 'desc' : 'asc';
            } else {
                state.classSort.key = key;
                state.classSort.order = key === 'no' ? 'asc' : 'desc'; // Default sort order
            }
            render();
        }

        function getBadgeForStudent(student, rank = -1) {
            // Top 3 Leaderboard Ranks get special titles
            if (rank === 0) return { text: '‡πÅ‡∏£‡∏á‡πÑ‡∏°‡πà‡∏´‡∏¢‡∏∏‡∏î‡∏â‡∏∏‡∏î‡πÑ‡∏°‡πà‡∏≠‡∏¢‡∏π‡πà', class: 'bg-gradient-to-r from-red-500 to-orange-500 text-white animate-pulse' };
            if (rank === 1) return { text: '‡∏õ‡∏•‡πà‡∏≠‡∏¢‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡∏Ç‡∏∂‡πâ‡∏ô‡∏°‡∏≤‡∏ö‡πâ‡∏≤‡∏á', class: 'bg-gradient-to-r from-sky-400 to-cyan-400 text-white' };
            if (rank === 2) return { text: '‡∏´‡∏•‡∏µ‡∏Å‡∏ó‡∏≤‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏ô‡∏≠‡∏∑‡πà‡∏ô‡πÅ‡∏ã‡∏á‡∏´‡∏ô‡πà‡∏≠‡∏¢‡∏Å‡πá‡πÑ‡∏î‡πâ', class: 'bg-gradient-to-r from-amber-500 to-yellow-500 text-white' };
            
            // Custom badge set by teacher (with random color)
            if (student.customBadge) {
                return { text: student.customBadge, class: getRandomBadgeClass(student.id) };
            }
            
            // Automatic badge based on points
            if (student.points >= 100) return { text: 'üî• ‡∏ô‡∏±‡∏Å‡∏™‡∏∞‡∏™‡∏°‡πÅ‡∏ï‡πâ‡∏°‡∏Ç‡∏±‡πâ‡∏ô‡πÄ‡∏ó‡∏û', class: 'bg-red-500 text-white' };
            if (student.points >= 50) return { text: '‚≠ê ‡∏î‡∏≤‡∏ß‡∏£‡∏∏‡πà‡∏á', class: 'bg-yellow-400 text-yellow-800' };
            if (student.points > 0) return { text: '‚ö° ‡∏°‡∏∑‡∏≠‡πÉ‡∏´‡∏°‡πà‡πÑ‡∏ü‡πÅ‡∏£‡∏á', class: 'bg-green-400 text-green-800' };
            
            return { text: '', class: '' };
        }
        
        function getRandomBadgeClass(studentId) {
            let hash = 0;
            for (let i = 0; i < studentId.length; i++) {
                hash = studentId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash % badgeColors.length);
            return badgeColors[index];
        }

        function getAvatarForStudent(studentId) {
            let hash = 0;
            for (let i = 0; i < studentId.length; i++) {
                hash = studentId.charCodeAt(i) + ((hash << 5) - hash);
            }
            const index = Math.abs(hash % avatars.length);
            return avatars[index];
        }

        function renderStudentList() {
            studentList.innerHTML = '';
            const isLeaderboard = state.activeClass === LEADERBOARD_KEY;

            if (isLeaderboard && state.leaderboardView === 'class') {
                renderClassLeaderboard();
                return;
            }

            // Set table headers
            if(isLeaderboard) {
                tableHeader.innerHTML = `
                    <tr class="border-b border-slate-200">
                        <th class="p-3">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                        <th class="p-3 whitespace-nowrap">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th class="p-3 text-center whitespace-nowrap">‡∏â‡∏≤‡∏¢‡∏≤</th>
                        <th class="p-3">‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                        <th class="p-3 text-center">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° ‚≠ê</th>
                        <th class="p-3 text-center">‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
                    </tr>`;
            } else {
                let secondColumnHeader = state.classSort.key === 'points' ? '‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö' : '‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà';
                tableHeader.innerHTML = `
                     <tr class="border-b border-slate-200">
                        <th class="p-3"></th>
                        <th class="p-3 text-center">${secondColumnHeader}</th>
                        <th class="p-3 whitespace-nowrap">‡∏ä‡∏∑‡πà‡∏≠ - ‡∏™‡∏Å‡∏∏‡∏•</th>
                        <th class="p-3 text-center whitespace-nowrap">‡∏â‡∏≤‡∏¢‡∏≤</th>
                        <th class="p-3 text-center">‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏° ‚≠ê</th>
                        <th class="p-3 text-center">‡∏î‡∏π‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå</th>
                    </tr>`;
            }

            // Get and sort students
            let studentsToDisplay;
            if (isLeaderboard) {
                studentsToDisplay = Object.values(state.students).sort((a, b) => b.points - a.points);
            } else {
                studentsToDisplay = Object.values(state.students).filter(s => s.class === state.activeClass);
                studentsToDisplay.sort((a, b) => {
                    if (state.classSort.key === 'no') {
                        const aNo = parseInt(a.no);
                        const bNo = parseInt(b.no);
                        return state.classSort.order === 'asc' ? aNo - bNo : bNo - aNo;
                    } else { // points
                        return state.classSort.order === 'asc' ? a.points - b.points : b.points - a.points;
                    }
                });
            }

            if (studentsToDisplay.length === 0) {
                 studentList.innerHTML = '<tr><td colspan="6" class="p-4 text-center">‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
                 return;
            }
            
            // Render rows
            studentsToDisplay.forEach((student, index) => {
                const row = document.createElement('tr');
                const fullName = `${student.prefix || ''}${student.firstName || ''} ${student.lastName || ''}`;
                
                if (isLeaderboard) {
                    const badge = getBadgeForStudent(student, index);
                    let rankDisplay = index + 1;
                    let rankClass = '';
                    let rankSize = 'text-2xl'; 
                    if(index === 0) { rankDisplay = 'ü•á'; rankClass = 'rank-1'; rankSize = 'text-4xl';}
                    if(index === 1) { rankDisplay = 'ü•à'; rankClass = 'rank-2'; rankSize = 'text-4xl';}
                    if(index === 2) { rankDisplay = 'ü•â'; rankClass = 'rank-3'; rankSize = 'text-4xl';}
                    row.className = `border-b border-slate-200 hover:shadow-lg transition-all duration-200 ${rankClass || (index % 2 !== 0 ? 'bg-violet-50' : 'bg-white')}`;
                    row.innerHTML = `
                        <td class="p-3 font-bold text-center ${rankSize}">${rankDisplay}</td>
                        <td class="p-3 font-medium text-slate-800 flex items-center gap-3 whitespace-nowrap">
                            <span class="text-2xl">${getAvatarForStudent(student.id)}</span>
                            <span>${fullName}</span>
                        </td>
                        <td class="p-3 text-center whitespace-nowrap">${badge.text ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${badge.class}">${badge.text}</span>` : ''}</td>
                        <td class="p-3">${student.class}</td>
                        <td class="p-3 text-center font-bold text-lg text-blue-500">${student.points}</td>
                        <td class="p-3 text-center">
                            <button class="view-profile-btn bg-purple-500 hover:bg-purple-600 text-white text-sm py-1 px-3 rounded-full transition-transform hover:scale-110" data-id="${student.id}">üìú ‡∏î‡∏π</button>
                        </td>
                    `;
                } else {
                     const badge = getBadgeForStudent(student, -1);
                     let secondColumnContent;
                     if (state.classSort.key === 'points') {
                        let rankDisplay;
                        let rankSize = 'text-2xl';
                        if (state.classSort.order === 'desc') {
                            rankDisplay = index + 1;
                            if (index === 0) { rankDisplay = 'ü•á'; rankSize = 'text-4xl'; }
                            if (index === 1) { rankDisplay = 'ü•à'; rankSize = 'text-4xl'; }
                            if (index === 2) { rankDisplay = 'ü•â'; rankSize = 'text-4xl'; }
                        } else {
                            rankDisplay = studentsToDisplay.length - index;
                        }
                        secondColumnContent = `<td class="p-3 text-center font-bold ${rankSize}">${rankDisplay}</td>`;
                     } else {
                        secondColumnContent = `<td class="p-3">${student.no}</td>`;
                     }

                     row.className = `border-b border-slate-200 hover:shadow-lg transition-all duration-200 ${(index % 2 !== 0 ? 'bg-violet-50' : 'bg-white')}`;
                     row.innerHTML = `
                        <td class="p-3 text-2xl">${getAvatarForStudent(student.id)}</td>
                        ${secondColumnContent}
                        <td class="p-3 font-medium text-slate-800 whitespace-nowrap">${fullName}</td>
                        <td class="p-3 text-center whitespace-nowrap">${badge.text ? `<span class="text-xs font-semibold px-2 py-1 rounded-full ${badge.class}">${badge.text}</span>` : ''}</td>
                        <td class="p-3 text-center font-bold text-lg text-blue-500">${student.points}</td>
                        <td class="p-3 text-center">
                            <button class="view-profile-btn bg-purple-500 hover:bg-purple-600 text-white text-sm py-1 px-3 rounded-full transition-transform hover:scale-110" data-id="${student.id}">üìú ‡∏î‡∏π</button>
                        </td>
                    `;
                }
                studentList.appendChild(row);
            });
            
            document.querySelectorAll('.view-profile-btn').forEach(btn => {
                btn.addEventListener('click', (e) => showProfileAndHistory(e.target.dataset.id));
            });
        }
        
        function renderClassLeaderboard() {
            tableHeader.innerHTML = `
                <tr class="border-b border-slate-200">
                    <th class="p-3">‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö</th>
                    <th class="p-3">‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                    <th class="p-3 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡πÄ‡∏â‡∏•‡∏µ‡πà‡∏¢ üìà</th>
                    <th class="p-3 text-center">‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏£‡∏ß‡∏°</th>
                    <th class="p-3 text-center">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</th>
                </tr>`;

            const classData = {};
            Object.values(state.students).forEach(student => {
                const className = student.class;
                if (!classData[className]) {
                    classData[className] = { totalPoints: 0, studentCount: 0 };
                }
                classData[className].totalPoints += student.points;
                classData[className].studentCount++;
            });

            const classRankings = Object.keys(classData).map(className => {
                const data = classData[className];
                const average = data.studentCount > 0 ? (data.totalPoints / data.studentCount) : 0;
                return {
                    className: className,
                    totalPoints: data.totalPoints,
                    studentCount: data.studentCount,
                    avgPoints: parseFloat(average.toFixed(1))
                };
            }).sort((a, b) => b.avgPoints - a.avgPoints);
            
            studentList.innerHTML = '';
            if (classRankings.length === 0) {
                studentList.innerHTML = '<tr><td colspan="5" class="p-4 text-center">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</td></tr>';
                return;
            }
            
            classRankings.forEach((classItem, index) => {
                const row = document.createElement('tr');
                let rankDisplay = index + 1;
                let rankClass = '';
                if(index === 0) { rankDisplay = 'ü•á'; rankClass = 'rank-1'; }
                if(index === 1) { rankDisplay = 'ü•à'; rankClass = 'rank-2'; }
                if(index === 2) { rankDisplay = 'ü•â'; rankClass = 'rank-3'; }
                row.className = `border-b border-slate-200 hover:scale-[1.01] hover:shadow-md transition-all duration-200 ${rankClass || (index % 2 !== 0 ? 'bg-slate-50' : 'bg-white')}`;
                row.innerHTML = `
                    <td class="p-3 font-bold text-center text-3xl">${rankDisplay}</td>
                    <td class="p-3 font-medium text-lg text-slate-800">${classItem.className}</td>
                    <td class="p-3 text-center font-bold text-xl text-blue-500">${classItem.avgPoints}</td>
                    <td class="p-3 text-center text-slate-500">${classItem.totalPoints}</td>
                    <td class="p-3 text-center text-slate-500">${classItem.studentCount}</td>
                `;
                studentList.appendChild(row);
            });
        }
        
        function showProfileAndHistory(studentId) {
            const student = state.students[studentId];
            if (!student) return;
            
            const fullName = `${student.prefix || ''}${student.firstName || ''} ${student.lastName || ''}`;
            modalStudentName.textContent = `‡πÇ‡∏õ‡∏£‡πÑ‡∏ü‡∏•‡πå: ${fullName}`;
            modalBody.innerHTML = '';

            const sortedHistory = [...student.history].sort((a, b) => new Date(a.date) - new Date(b.date));

            // Chart Data Processing
            let cumulativePoints = 0;
            const chartLabels = ['‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô'];
            const chartData = [0];

            sortedHistory.forEach(item => {
                cumulativePoints += item.points;
                chartLabels.push(new Date(item.date).toLocaleDateString('th-TH'));
                chartData.push(cumulativePoints);
            });

            // Chart Rendering
            const ctx = document.getElementById('profile-chart-canvas').getContext('2d');
            if (profileChart) {
                profileChart.destroy();
            }
            profileChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: chartLabels,
                    datasets: [{
                        label: '‡πÅ‡∏ï‡πâ‡∏°‡∏™‡∏∞‡∏™‡∏°',
                        data: chartData,
                        fill: true,
                        tension: 0.1,
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        segment: {
                            borderColor: ctx => (ctx.p1.parsed.y < ctx.p0.parsed.y ? 'rgb(239, 68, 68)' : 'rgb(34, 197, 94)'),
                            backgroundColor: ctx => (ctx.p1.parsed.y < ctx.p0.parsed.y ? 'rgba(239, 68, 68, 0.1)' : 'rgba(34, 197, 94, 0.1)'),
                        }
                    }]
                },
                options: {
                    responsive: true,
                    scales: { y: { beginAtZero: true } }
                }
            });

            // History List Rendering
            if (sortedHistory.length === 0) {
                modalBody.innerHTML = '<p class="text-center text-slate-500">‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥</p>';
            } else {
                const list = document.createElement('ul');
                [...sortedHistory].reverse().forEach(item => { // Show newest first
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 border-b border-slate-200';
                    const pointClass = item.points > 0 ? 'text-green-600' : 'text-red-600';
                    const sign = item.points > 0 ? '+' : '';
                    li.innerHTML = `
                        <div>
                            <p class="font-semibold">${item.reason}</p>
                            <p class="text-sm text-slate-500">${new Date(item.date).toLocaleString('th-TH')}</p>
                        </div>
                        <div class="font-bold text-lg ${pointClass}">${sign}${item.points}</div>
                    `;
                    list.appendChild(li);
                });
                modalBody.appendChild(list);
            }

            // Show history by default
            profileHistoryView.classList.remove('hidden');
            profileGraphView.classList.add('hidden');
            profileHistoryBtn.classList.add('filter-btn-active');
            profileGraphBtn.classList.remove('filter-btn-active');

            profileModal.style.display = 'block';
        }

        // --- Data Fetching ---
        function fetchFromGoogleSheet() {
             Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏î‡∏∂‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡∏™‡∏±‡∏Å‡∏Ñ‡∏£‡∏π‡πà üîÑ', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            const script = document.createElement('script');
            script.src = `${APP_SCRIPT_URL}?callback=handleGsData`;
            document.body.appendChild(script);
            script.onload = () => script.remove();
            script.onerror = () => Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏ä‡∏∑‡πà‡∏≠‡∏°‡∏ï‡πà‡∏≠‡∏Å‡∏±‡∏ö Google Sheet ‡πÑ‡∏î‡πâ', 'error');
        }
        
        window.handleGsData = function(data) {
            if (data.error) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', data.error, 'error'); return; }
            const newClasses = Object.keys(data).filter(k => k !== 'mission').sort(naturalSort);
            state.classes = newClasses;
            state.students = {};
            state.mission = data.mission || { text: '', timestamp: null, imageUrl: '' };

            newClasses.forEach(className => {
                data[className].forEach(gsStudent => {
                    const studentId = `${className}-${gsStudent.no}`;
                    state.students[studentId] = {
                        id: studentId, no: gsStudent.no, 
                        prefix: gsStudent.prefix,
                        firstName: gsStudent.firstName,
                        lastName: gsStudent.lastName,
                        class: className, points: gsStudent.points || 0,
                        customBadge: gsStudent.customBadge || '',
                        history: gsStudent.history || []
                    };
                });
            });

            if (state.activeClass !== LEADERBOARD_KEY && !newClasses.includes(state.activeClass)) {
                state.activeClass = LEADERBOARD_KEY;
            }
            
            render();
            checkAndShowNewMission();
            Swal.close();
        }

        // --- View Management ---
        function showLogin() {
            loginView.classList.remove('hidden');
            dashboardView.classList.add('hidden');
            adminView.classList.add('hidden');
        }
        function showDashboard() {
            loginView.classList.add('hidden');
            dashboardView.classList.remove('hidden');
            adminView.classList.add('hidden');
            render();
        }
        function showAdminPanel() {
            loginView.classList.add('hidden');
            dashboardView.classList.add('hidden');
            adminView.classList.remove('hidden');
            renderAdminPanel();
        }

        // --- Admin Functions ---
        function renderAdminPanel() {
            updatePointManagementUI();
            renderClassManagementButtons();
        }
        
        function updatePointManagementUI() {
            const isBulk = state.adminPointMode === 'bulk';
            modeSingleBtn.classList.toggle('filter-btn-active', !isBulk);
            modeBulkBtn.classList.toggle('filter-btn-active', isBulk);

            singleStudentSelector.classList.toggle('hidden', isBulk);
            bulkStudentSelector.classList.toggle('hidden', !isBulk);
            document.getElementById('search-student-admin').classList.toggle('hidden', isBulk);
            populatePointManagementSelectors();
        }

        function populatePointManagementSelectors() {
            const classSelect = document.getElementById('class-select-for-points');
            const studentSelect = document.getElementById('student-select-for-points');
            const currentClass = classSelect.value;
            
            classSelect.innerHTML = '<option value="">-- 1. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏Å‡πà‡∏≠‡∏ô --</option>';
            state.classes.forEach(c => classSelect.add(new Option(c, c)));
            classSelect.value = currentClass;
            
            studentSelect.innerHTML = '<option value="">-- 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô --</option>';
            bulkStudentList.innerHTML = '<p class="text-slate-500">‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô</p>';
            
            if (!currentClass) return;

            const studentsInClass = Object.values(state.students)
                .filter(s => s.class === currentClass)
                .sort((a,b) => parseInt(a.no) - parseInt(b.no));

            // Populate for single mode
            studentsInClass.forEach(s => {
                const fullName = `${s.prefix || ''}${s.firstName || ''} ${s.lastName || ''}`;
                studentSelect.add(new Option(`${s.no} - ${fullName}`, s.id));
            });

            // Populate for bulk mode
            if (studentsInClass.length > 0) {
                bulkStudentList.innerHTML = '';
                studentsInClass.forEach(s => {
                    const div = document.createElement('div');
                    const fullName = `${s.prefix || ''}${s.firstName || ''} ${s.lastName || ''}`;
                    div.innerHTML = `
                        <input type="checkbox" id="student-${s.id}" value="${s.id}" class="student-checkbox mr-2">
                        <label for="student-${s.id}">${s.no}. ${fullName}</label>
                    `;
                    bulkStudentList.appendChild(div);
                });
            } else {
                 bulkStudentList.innerHTML = '<p class="text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</p>';
            }
            filterAdminStudentDropdown();
        }

        function filterAdminStudentDropdown() {
            const searchTerm = document.getElementById('search-student-admin').value.toLowerCase();
            const studentSelect = document.getElementById('student-select-for-points');
            const options = studentSelect.getElementsByTagName('option');

            for (let i = 0; i < options.length; i++) {
                const option = options[i];
                if (option.value === "") { // Always show placeholder
                    option.style.display = "";
                    continue;
                }
                const optionText = option.textContent.toLowerCase();
                if (optionText.includes(searchTerm)) {
                    option.style.display = "";
                } else {
                    option.style.display = "none";
                }
            }
        }

        function renderClassManagementButtons() {
            classManagementButtons.innerHTML = '';
            state.classes.forEach(className => {
                const button = document.createElement('button');
                button.textContent = `‡∏´‡πâ‡∏≠‡∏á ${className}`;
                button.className = 'w-full p-3 bg-white rounded-lg shadow-sm border text-slate-700 hover:bg-indigo-50 hover:border-indigo-400 transition-all duration-300';
                button.onclick = () => openClassManagementModal(className);
                classManagementButtons.appendChild(button);
            });
        }
        
        function openClassManagementModal(className) {
            classModalTitle.textContent = `‡∏à‡∏±‡∏î‡∏Å‡∏≤‡∏£‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏´‡πâ‡∏≠‡∏á ${className}`;
            classModalStudentList.innerHTML = '';
            
            const studentsInClass = Object.values(state.students)
                .filter(s => s.class === className)
                .sort((a,b) => parseInt(a.no) - parseInt(b.no));

            if (studentsInClass.length > 0) {
                studentsInClass.forEach(s => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center py-1';
                    const fullName = `${s.prefix || ''}${s.firstName || ''} ${s.lastName || ''}`;
                    li.innerHTML = `
                        <span>${s.no}. ${fullName}</span>
                        <button class="edit-student-btn text-sm bg-yellow-400 hover:bg-yellow-500 text-white py-1 px-2 rounded-md transition-transform hover:scale-105" data-id="${s.id}">‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç</button>
                    `;
                    classModalStudentList.appendChild(li);
                });
            } else {
                classModalStudentList.innerHTML = '<li class="text-center text-slate-500">‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ</li>';
            }
            
            // Re-attach event listeners for edit buttons inside the modal
            classModalStudentList.querySelectorAll('.edit-student-btn').forEach(btn => btn.addEventListener('click', handleEditStudent));
            
            classModalAddStudentBtn.dataset.class = className; // Set class context for adding new student
            classManagementModal.style.display = 'block';
        }

        async function handleEditStudent(e) {
            const studentId = e.target.dataset.id;
            const student = state.students[studentId];
            if (!student) return;
            const fullName = `${student.prefix || ''}${student.firstName || ''} ${student.lastName || ''}`;

            const { value: formValues } = await Swal.fire({
                title: `‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: ${fullName}`,
                html:
                    `<div class="space-y-4 text-left">` +
                        `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`+
                            `<div><label for="swal-input1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label><input id="swal-input1" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà" value="${student.no}"></div>` +
                            `<div><label for="swal-input2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</label><select id="swal-input2" class="swal2-select">
                                <option value="‡∏î.‡∏ä." ${student.prefix === '‡∏î.‡∏ä.' ? 'selected' : ''}>‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                                <option value="‡∏î.‡∏ç." ${student.prefix === '‡∏î.‡∏ç.' ? 'selected' : ''}>‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                                <option value="‡∏ô‡∏≤‡∏¢" ${student.prefix === '‡∏ô‡∏≤‡∏¢' ? 'selected' : ''}>‡∏ô‡∏≤‡∏¢</option>
                                <option value="‡∏ô.‡∏™." ${student.prefix === '‡∏ô.‡∏™.' ? 'selected' : ''}>‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                            </select></div>`+
                        `</div>`+
                        `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`+
                            `<div><label for="swal-input3">‡∏ä‡∏∑‡πà‡∏≠:</label><input id="swal-input3" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠" value="${student.firstName || ''}"></div>`+
                            `<div><label for="swal-input4">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label><input id="swal-input4" class="swal2-input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•" value="${student.lastName || ''}"></div>`+
                        `</div>`+
                        `<div><label for="swal-input5">‡∏â‡∏≤‡∏¢‡∏≤ (‡∏ñ‡πâ‡∏≤‡πÄ‡∏ß‡πâ‡∏ô‡∏ß‡πà‡∏≤‡∏á‡∏à‡∏∞‡πÅ‡∏™‡∏î‡∏á‡∏â‡∏≤‡∏¢‡∏≤‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥):</label><input id="swal-input5" class="swal2-input" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏´‡∏±‡∏ß‡∏´‡∏ô‡πâ‡∏≤‡∏´‡πâ‡∏≠‡∏á" value="${student.customBadge || ''}"></div>`+
                    `</div>`,
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('swal-input1').value,
                    document.getElementById('swal-input2').value,
                    document.getElementById('swal-input3').value,
                    document.getElementById('swal-input4').value,
                    document.getElementById('swal-input5').value
                ]
            });

            if (formValues) {
                const [newNo, newPrefix, newFirstName, newLastName, newStudentBadge] = formValues;
                if (!newNo || !newFirstName || !newLastName) {
                    Swal.fire('‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö', 'error');
                    return;
                }
                
                const newId = `${student.class}-${newNo}`;
                if (newNo !== student.no && state.students[newId]) {
                    Swal.fire('‡∏ã‡πâ‡∏≥!', `‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${newNo} ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß`, 'error');
                    return;
                }
                
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å...', allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                try {
                    const payload = { 
                        action: 'editStudent', className: student.class, 
                        oldStudentNo: student.no, newStudentNo: newNo,
                        newStudentPrefix: newPrefix, newStudentFirstName: newFirstName, newStudentLastName: newLastName,
                        newStudentBadge: newStudentBadge
                    };
                    const response = await fetch(APP_SCRIPT_URL, {
                        method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    
                    if (result.status === 'success') {
                        // Update state
                        delete state.students[studentId];
                        state.students[newId] = { ...student, id: newId, no: newNo, prefix: newPrefix, firstName: newFirstName, lastName: newLastName, customBadge: newStudentBadge };
                        render();
                        // Refresh the modal content
                        openClassManagementModal(student.class);
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢', 'success');
                    } else { throw new Error(result.message); }
                } catch (error) {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
                }
            }
        }
        
        async function handleAddStudentToClass(e) {
            const className = e.target.dataset.class;
             const { value: formValues } = await Swal.fire({
                title: `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÉ‡∏ô‡∏´‡πâ‡∏≠‡∏á ${className}`,
                html:
                    `<div class="space-y-4 text-left">` +
                        `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`+
                            `<div><label for="swal-input1">‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà:</label><input id="swal-input1" class="swal2-input" placeholder="‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà"></div>` +
                            `<div><label for="swal-input2">‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤:</label><select id="swal-input2" class="swal2-select">
                                <option value="">--‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏Ñ‡∏≥‡∏ô‡∏≥‡∏´‡∏ô‡πâ‡∏≤--</option>
                                <option value="‡∏î.‡∏ä.">‡πÄ‡∏î‡πá‡∏Å‡∏ä‡∏≤‡∏¢</option>
                                <option value="‡∏î.‡∏ç.">‡πÄ‡∏î‡πá‡∏Å‡∏´‡∏ç‡∏¥‡∏á</option>
                                <option value="‡∏ô‡∏≤‡∏¢">‡∏ô‡∏≤‡∏¢</option>
                                <option value="‡∏ô.‡∏™.">‡∏ô‡∏≤‡∏á‡∏™‡∏≤‡∏ß</option>
                            </select></div>`+
                        `</div>`+
                        `<div class="grid grid-cols-1 md:grid-cols-2 gap-4">`+
                            `<div><label for="swal-input3">‡∏ä‡∏∑‡πà‡∏≠:</label><input id="swal-input3" class="swal2-input" placeholder="‡∏ä‡∏∑‡πà‡∏≠"></div>`+
                            `<div><label for="swal-input4">‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•:</label><input id="swal-input4" class="swal2-input" placeholder="‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•"></div>`+
                        `</div>`+
                    `</div>`,
                focusConfirm: false,
                preConfirm: () => [
                    document.getElementById('swal-input1').value,
                    document.getElementById('swal-input2').value,
                    document.getElementById('swal-input3').value,
                    document.getElementById('swal-input4').value
                ]
            });

            if (formValues) {
                const [studentNo, prefix, firstName, lastName] = formValues;
                if (!studentNo || !firstName || !lastName) {
                    Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å ‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà, ‡∏ä‡∏∑‡πà‡∏≠ ‡πÅ‡∏•‡∏∞‡∏ô‡∏≤‡∏°‡∏™‡∏Å‡∏∏‡∏•‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô', 'warning');
                    return;
                }
                
                // Add student and refresh modal on success
                const studentId = `${className}-${studentNo}`;
                if (state.students[studentId]) { Swal.fire('‡∏ã‡πâ‡∏≥!', '‡∏°‡∏µ‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πâ‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡πÅ‡∏•‡πâ‡∏ß (‡πÉ‡∏ô‡πÅ‡∏≠‡∏õ)', 'error'); return; }
                
                Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', text: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏° ${prefix}${firstName} ‡∏•‡∏á‡πÉ‡∏ô‡∏ä‡∏µ‡∏ï‡∏´‡πâ‡∏≠‡∏á ${className}`, allowOutsideClick: false, didOpen: () => Swal.showLoading() });
                
                try {
                    const payload = { action: 'addStudent', className, studentNo, studentPrefix: prefix, studentFirstName: firstName, studentLastName: lastName };
                    const response = await fetch(APP_SCRIPT_URL, {
                        method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });
                    const result = await response.json();
                    if (result.status === 'success') {
                        state.students[studentId] = {
                            id: studentId, no: studentNo, 
                            prefix: prefix, firstName: firstName, lastName: lastName,
                            class: className, points: 0, history: [], customBadge: ''
                        };
                        render();
                        openClassManagementModal(className); // Refresh modal
                        Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${prefix}${firstName} ‡πÉ‡∏ô‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${className} ‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                    } else { throw new Error(result.message || 'Unknown error'); }
                } catch (error) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`, 'error'); }
            }
        }

        async function handlePointUpdate(isAdding) {
            let points = Math.abs(parseInt(document.getElementById('points-input').value));
            const reason = document.getElementById('reason-input').value;

            if (isNaN(points) || points <= 0 || !reason) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏ï‡πâ‡∏° (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0) ‡πÅ‡∏•‡∏∞‡πÄ‡∏´‡∏ï‡∏∏‡∏ú‡∏•', 'warning');
                return;
            }
            if (!isAdding) { points = -points; }
            
            const selectedStudentIds = [];
            if (state.adminPointMode === 'single') {
                const singleId = document.getElementById('student-select-for-points').value;
                if(singleId) selectedStudentIds.push(singleId);
            } else {
                document.querySelectorAll('.student-checkbox:checked').forEach(cb => selectedStudentIds.push(cb.value));
            }

            if (selectedStudentIds.length === 0) {
                Swal.fire('‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡πÑ‡∏î‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô', 'warning');
                return;
            }
            
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•...', text: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÉ‡∏´‡πâ‡∏Ñ‡∏∞‡πÅ‡∏ô‡∏ô‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${selectedStudentIds.length} ‡∏Ñ‡∏ô`, allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            // Local update first for instant UI feedback
            const historyEntry = { date: new Date().toISOString(), reason: reason, points: points };
            selectedStudentIds.forEach(id => {
                state.students[id].points += points;
                state.students[id].history.push(historyEntry);
            });
            render();
            document.getElementById('points-input').value = '';
            document.getElementById('reason-input').value = '';
            
            // Sync with Google Sheet
            const className = document.getElementById('class-select-for-points').value;
            const studentNos = selectedStudentIds.map(id => state.students[id].no);
            const payload = {
                action: 'bulkUpdatePoints',
                className: className,
                studentNos: studentNos,
                points: points,
                reason: reason,
            };

            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST', redirect: "follow", headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏ï‡πâ‡∏°‡πÅ‡∏•‡∏∞‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏Ç‡∏≠‡∏á‡∏ô‡∏±‡∏Å‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${selectedStudentIds.length} ‡∏Ñ‡∏ô‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                } else { throw new Error(result.message || 'Unknown error from Apps Script'); }
            } catch (error) {
                console.error('Error syncing with Google Sheet:', error);
                Swal.fire({ title: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', text: '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á Google Sheet ‡πÑ‡∏î‡πâ: ' + error.message, icon: 'error' });
            }
        }
        
        async function addClass() {
            const className = document.getElementById('new-class-name').value.trim();
            if (!className) { Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏ä‡∏∑‡πà‡∏≠‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô', 'warning'); return; }
            if (state.classes.includes(className)) { Swal.fire('‡∏ã‡πâ‡∏≥!', '‡∏°‡∏µ‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ô‡∏µ‡πâ‡∏≠‡∏¢‡∏π‡πà‡πÅ‡∏•‡πâ‡∏ß', 'error'); return; }

            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô...', text: `‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏´‡πâ‡∏≠‡∏á ${className}`, allowOutsideClick: false, didOpen: () => Swal.showLoading() });
            try {
                const payload = { action: 'addClass', className: className };
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST', redirect: 'follow', headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    state.classes.push(className);
                    state.classes.sort(naturalSort);
                    render();
                    renderAdminPanel();
                    document.getElementById('new-class-name').value = '';
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', `‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡∏±‡πâ‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ô ${className} ‡πÅ‡∏•‡∏∞‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ä‡∏µ‡∏ï‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß`, 'success');
                } else { throw new Error(result.message || 'Unknown error'); }
            } catch (error) { Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏´‡πâ‡∏≠‡∏á‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡πÑ‡∏î‡πâ: ${error.message}`, 'error'); }
        }
        
        async function announceMission() {
            const newMissionText = document.getElementById('new-mission-text');
            const newMissionImageFile = document.getElementById('new-mission-image-file');

            const missionText = newMissionText.value.trim();
            const file = newMissionImageFile.files[0];

            if (!missionText) {
                Swal.fire('‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÑ‡∏°‡πà‡∏Ñ‡∏£‡∏ö!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à', 'warning');
                return;
            }
            
            Swal.fire({ title: '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à...', text: file ? '‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û...' : '', allowOutsideClick: false, didOpen: () => Swal.showLoading() });

            let payload = { action: 'announceMission', missionText, missionImageUrl: '' };

            if (file) {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const fileData = reader.result;
                    payload.fileData = fileData;
                    payload.mimeType = file.type;
                    sendMissionPayload(payload);
                };
                reader.onerror = error => {
                    Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', '‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏£‡∏π‡∏õ‡∏†‡∏≤‡∏û‡πÑ‡∏î‡πâ', 'error');
                };
            } else {
                sendMissionPayload(payload);
            }
        }

        async function sendMissionPayload(payload) {
            try {
                const response = await fetch(APP_SCRIPT_URL, {
                    method: 'POST',
                    redirect: 'follow',
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const result = await response.json();
                if (result.status === 'success') {
                    state.mission = { text: payload.missionText, imageUrl: result.imageUrl || '', timestamp: new Date().getTime() };
                    render();
                    document.getElementById('new-mission-text').value = '';
                    document.getElementById('new-mission-image-file').value = '';
                    Swal.fire('‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à!', '‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß', 'success');
                } else { throw new Error(result.message || 'Unknown error'); }
            } catch (error) {
                Swal.fire('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î!', `‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏õ‡∏£‡∏∞‡∏Å‡∏≤‡∏®‡∏†‡∏≤‡∏£‡∏Å‡∏¥‡∏à‡πÑ‡∏î‡πâ: ${error.message}`, 'error');
            }
        }

        // --- Event Listeners ---
        document.getElementById('show-login-btn').addEventListener('click', showLogin);
        document.getElementById('back-to-scoreboard-btn').addEventListener('click', showDashboard);
        document.getElementById('login-btn').addEventListener('click', () => {
            if (document.getElementById('password').value === 'teacher123') { 
                state.loggedIn = true; 
                render(); 
                showDashboard();
            } else { Swal.fire('‡∏£‡∏´‡∏±‡∏™‡∏ú‡πà‡∏≤‡∏ô‡πÑ‡∏°‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á!', '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏•‡∏≠‡∏á‡πÉ‡∏´‡∏°‡πà‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á', 'error'); }
        });
        
        // Teacher Menu Dropdown
        teacherMenuBtn.addEventListener('click', () => teacherMenuDropdown.classList.toggle('hidden'));
        document.getElementById('fetch-gs-btn').addEventListener('click', (e) => { e.preventDefault(); fetchFromGoogleSheet(); teacherMenuDropdown.classList.add('hidden'); });
        document.getElementById('admin-panel-btn').addEventListener('click', (e) => { e.preventDefault(); showAdminPanel(); teacherMenuDropdown.classList.add('hidden'); });
        document.getElementById('logout-btn').addEventListener('click', (e) => { e.preventDefault(); state.loggedIn = false; render(); });

        // Leaderboard Filters
        filterIndividualBtn.addEventListener('click', () => { state.leaderboardView = 'individual'; render(); });
        filterClassBtn.addEventListener('click', () => { state.leaderboardView = 'class'; render(); });

        // Class Sort Filters
        sortByNoBtn.addEventListener('click', () => handleSort('no'));
        sortByPointsBtn.addEventListener('click', () => handleSort('points'));
        
        // Admin Point Mode
        modeSingleBtn.addEventListener('click', () => {
            state.adminPointMode = 'single';
            updatePointManagementUI();
        });
        modeBulkBtn.addEventListener('click', () => {
            state.adminPointMode = 'bulk';
            updatePointManagementUI();
        });

        document.getElementById('class-select-for-points').addEventListener('change', populatePointManagementSelectors);
        selectAllCheckbox.addEventListener('change', (e) => {
            document.querySelectorAll('.student-checkbox').forEach(cb => {
                cb.checked = e.target.checked;
            });
        });

        document.getElementById('back-to-dashboard-btn').addEventListener('click', showDashboard);
        document.getElementById('add-points-btn').addEventListener('click', () => handlePointUpdate(true));
        document.getElementById('remove-points-btn').addEventListener('click', () => handlePointUpdate(false));
        document.getElementById('add-class-btn').addEventListener('click', addClass);
        document.getElementById('search-student-admin').addEventListener('input', filterAdminStudentDropdown);
        
        
        // Modal Listeners
        document.getElementById('rules-btn').addEventListener('click', () => { rulesModal.style.display = 'block'; });
        profileModal.querySelector('.close-btn').addEventListener('click', () => { profileModal.style.display = 'none'; });
        rulesModal.querySelector('.close-btn').addEventListener('click', () => { rulesModal.style.display = 'none'; });
        classManagementModal.querySelector('.close-btn').addEventListener('click', () => { classManagementModal.style.display = 'none'; });
        classModalAddStudentBtn.addEventListener('click', handleAddStudentToClass);

        profileGraphBtn.addEventListener('click', () => {
            profileGraphView.classList.remove('hidden');
            profileHistoryView.classList.add('hidden');
            profileGraphBtn.classList.add('filter-btn-active');
            profileHistoryBtn.classList.remove('filter-btn-active');
        });

        profileHistoryBtn.addEventListener('click', () => {
            profileHistoryView.classList.remove('hidden');
            profileGraphView.classList.add('hidden');
            profileHistoryBtn.classList.add('filter-btn-active');
            profileGraphBtn.classList.remove('filter-btn-active');
        });

        window.addEventListener('click', (event) => { 
            if (event.target == profileModal) profileModal.style.display = "none"; 
            if (event.target == rulesModal) rulesModal.style.display = "none";
            if (event.target == classManagementModal) classManagementModal.style.display = "none";
            if (teacherMenuBtn && !teacherMenuBtn.contains(event.target) && !teacherMenuDropdown.contains(event.target)) {
                teacherMenuDropdown.classList.add('hidden');
            }
        });

        initializeApp();
    </script>

</body>
</html>




